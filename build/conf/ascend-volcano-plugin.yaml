component: ascend-volcano-plugin
product: MindXDL
systemEnv:
  - workspace
  - GOPATH
  - processor
version:
BASE_PATH:
  "{{ systemEnv.workspace }}/go/src/volcano.sh/volcano/pkg/scheduler/plugins/ascend-volcano-plugin"
compile:
  name: ascend-volcano-plugin
  input:
    dependency:
      - name: volcano
        version: 1.0
        type: opensource
      - name: controller-manager
        offering: MindXDL
        version: 1.0
        type: opensource
        buildType:
        buildFile: "{{ systemEnv.workspace }}/{{component}}/build/conf"
      - name: scheduler
        offering: MindXDL
        version: 1.0
        type: opensource
        buildType:
        buildFile: "{{ systemEnv.workspace }}/{{component}}/build/conf"
    envVariables:
      GONOSUMDB: "*"
      GO111MODULE: 'on'
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CC: "/usr/local/musl/bin/musl-gcc"
      CGO_ENABLED: "1"
    files:
      exclude:
        - remove: [ "{{ BASE_PATH }}/output/*.so" ]
  process:
    language: go
    compilePath: "{{ BASE_PATH }}/output"
    parameters: [
      ["buildmode","plugin"],
    ['ldflags', '-s -linkmode=external -extldflags=-Wl,-z,now -X "volcano.sh/volcano/pkg/scheduler/plugins/ascend-volcano-plugin.PluginName=volcano-npu_{{ version }}_linux-{{ systemEnv.processor }}"'],
    ["o", "volcano-npu_{{ version }}_linux-{{ systemEnv.processor }}.so {{ BASE_PATH }}"],
    ]
  output:
    files:
      include:
        - commands:
            - command: 'sed -i "s/name: volcano-npu-.*/name: volcano-npu_{{ version }}_linux-{{ systemEnv.processor }}/" "{{BASE_PATH}}"/output/volcano-*.yaml'
        - mode:
            src:
              - "{{ BASE_PATH }}/output/*.so"
              - "{{ BASE_PATH }}/output/Dockerfile*"
              - "{{ BASE_PATH }}/output/volcano-*.yaml"
            mode: 400
        - makeArchive:
            - src: "{{ BASE_PATH }}/output"
              des: "{{ systemEnv.workspace }}/go/src/volcano.sh/volcano/pkg/scheduler/plugins/ascend-volcano-plugin/output/Ascend-mindxdl-volcano_{{ pkgversion }}_linux-{{ systemEnv.processor }}"
              prefix: zip
              arch: "{{ systemEnv.processor }}"

test:
  input:
    files:
  process:
    type: ut
    testTool: shell
    execdir: "{{systemEnv.workspace}}/{{component}}/build"
    parameters: ""
    script: "testBuild.sh"
  output: