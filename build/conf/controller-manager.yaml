component: controller_manager
product: MindXDL
systemEnv:
  - workspace
  - DATE
BASE_PATH: "{{ systemEnv.workspace }}/go/src/volcano.sh/volcano/pkg/scheduler/plugins/ascend-volcano-plugin/"
CMD_PATH: "{{ systemEnv.workspace }}/go/src/volcano.sh/volcano/cmd/"
BASE_VER: v1.4.0
compile:
  input:
    envVariables:
      GO111MODULE: 'on'
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CC: "/usr/local/musl/bin/musl-gcc"
      CGO_ENABLED: "1"
    files:
      include:
        - copy:
            src: [ '{{ systemEnv.workspace }}/go/opensource/volcano.sh' ]
            des: "{{ systemEnv.workspace }}/go/src/"
        - copy:
            src: [ '{{ systemEnv.workspace }}/ascend-volcano-plugin' ]
            des: "{{ systemEnv.workspace }}/go/src/volcano.sh/volcano/pkg/scheduler/plugins/"
        - commands:
            - command: cd {{ systemEnv.workspace }}/go/src/volcano.sh/volcano;go mod tidy
            - command: cd {{ systemEnv.workspace }}/go/src/volcano.sh/volcano;go mod download
            - command: cd {{ systemEnv.workspace }}/go/src/volcano.sh/volcano;go mod vendor
            - command: export DATE=$(date "+%Y-%m-%d %H:%M:%S")
      exclude:
        - remove: ["{{ BASE_PATH }}/output/vc-controller-manager"]

  process:
    language: go
    compilePath: "{{ BASE_PATH }}/output"
    parameters: [
      ["buildmode", "pie"],
      ["ldflags", '-s -linkmode=external -extldflags=-Wl,-z,now -X "volcano.sh/volcano/pkg/version.Built={{ systemEnv.DATE }}" -X "volcano.sh/volcano/pkg/version.Version={{ BASE_VER }}"'],
      ["o", "vc-controller-manager {{ CMD_PATH }}/controller-manager"]
    ]
  output:
    files:
      input:
        - mode:
            src:
              - "{{ BASE_PATH }}/output/vc-controller-manager"
            mode: 500

